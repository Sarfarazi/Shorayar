@model  Council.Core.Models.HomePageViewModel
@using Council.Core
@using Microsoft.AspNet.Identity;
@using Council.Core.Enums;
@using Council.UI.CustomAuthentication;
@{
    CustomPrincipal _User = (CustomPrincipal)HttpContext.Current.User;
    string UserID = _User.UserId;

    var readyCouncil = Model != null ? Model.MyLetters.Where(l => l.LetterStatus == LetterStatus.ReadyForVoting).ToList() : null;

    // Commission
    var aa = Model != null ? Model.MyLetters.Where(l => l.LetterStatus == LetterStatus.CommissionVoting).ToList() : null;

    var commissionReadyCouncil = Model != null ? Model.MyLetters.Where(l => l.LetterStatus == LetterStatus.CommissionReadyForVoting
                 && Model.MyCommissions.Any(mc => mc.CommissionId == l.CommissionId)).ToList() : null;

    readyCouncil.AddRange(commissionReadyCouncil);

    readyCouncil = readyCouncil.OrderByDescending(m => m.CreatedOn).ToList();

    bool userIsBoss = Model != null ? Model.UserIsBoss : false;
    bool userIsBossHelper = Model != null ? Model.UserIsBossHelper : false;
    bool userIsSiteManager = Model != null ? Model.UserIsSiteManager : false;
    bool userIsMember = Model != null ? Model.UserIsMember : false;
}
@*<h4 class="card-title">صدور اجازه رای گیری</h4>*@
@if (readyCouncil.Count > 0 && userIsMember)
{

    var count = 1;
    <div class="table-responsive">
        <table class="table table-bordered table-condensed table-hover table-striped allletters">
            <thead>
                <tr>
                    <td>ردیف</td>
                    <td>شماره نامه</td>
                    <td>موضوع</td>
                    <td></td>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in readyCouncil)
                    {
                        var href = (item.LetterStatus == LetterStatus.ReadyForVoting) ?
                            ("/Letter/AllowCouncil?letterID=" + item.ID) :
                            ("/Letter/CommissionAllowCouncil?letterID=" + item.ID);
                        var outHref = (item.LetterStatus == LetterStatus.ReadyForVoting) ?
                           ("/Letter/ChangeOutOfReadyForCouncil?letterID=" + item.ID) :
                           ("/Letter/ChangeOutOfReadyForCommisionCouncil?letterID=" + item.ID);
                        bool isCommission = (item.LetterStatus == LetterStatus.CommissionReadyForVoting);
                    <tr>
                        <td>@(count++)</td>
                        <td>@item.LetterNumber</td>
                        <td>
                            @{if (!String.IsNullOrEmpty(item.CommissionName))
                                { <span>[ کمیسیون  @item.CommissionName ]</span>}
                            }
                            <a href="@("/Letter/LetterItem?letterID=" + item.ID)">

                                [ @item.Title ]
                            </a>
                        </td>
                        <td>
                            @if (isCommission)
                            {
                                if (Model.MyCommissions.Any(c => c.BossId == UserID && c.CommissionId == item.CommissionId))
                                {
                                    <a href="@href" class="btn btn-default btn-sm">
                                        صدور اجازه رای گیری
                                    </a>
                                    <a href="@outHref" class="btn btn-default btn-sm">
                                        خروج از دستور جلسه
                                    </a>
                                }
                            }
                            else
                            {
                                if (userIsBoss || userIsBossHelper)
                                {
                                    <a href="@href" class="btn btn-default btn-sm">
                                        صدور اجازه رای گیری
                                    </a>
                                    <a href="@outHref" class="btn btn-default btn-sm">
                                        خروج از دستور جلسه
                                    </a>
                                }
                            }
                        </td>
                    </tr>
           }
            </tbody>
        </table>
    </div>
}
else
{
    <p>داده ای برای نمایش وجود ندارد</p>
}
